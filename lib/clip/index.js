// Generated by CoffeeScript 1.6.2
(function() {
  var Clip, ClipWatchers, PropertyChain, ScriptWatcher, bindable, defaultModifiers, dref, events,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  bindable = require("bindable");

  dref = require("dref");

  events = require("events");

  defaultModifiers = require("./modifiers");

  /*
   Reads a property chain
  */


  PropertyChain = (function() {
    PropertyChain.prototype.__isPropertyChain = true;

    function PropertyChain(watcher) {
      this.watcher = watcher;
      this._commands = [];
      this.clip = this.watcher.clip;
    }

    PropertyChain.prototype.ref = function(path) {
      this._commands.push({
        ref: path
      });
      return this;
    };

    PropertyChain.prototype.castAs = function(name) {
      this.watcher.cast[name] = this;
      return this;
    };

    PropertyChain.prototype.path = function() {
      var c, path, _i, _len, _ref;

      path = [];
      _ref = this._commands;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        c = _ref[_i];
        path.push(c.ref);
      }
      return path.join(".");
    };

    PropertyChain.prototype.self = function(path) {
      this._self = true;
      this.ref(path);
      return this;
    };

    PropertyChain.prototype.call = function(path, args) {
      this._commands.push({
        ref: path,
        args: args
      });
      return this;
    };

    PropertyChain.prototype.exec = function() {
      this.currentValue = this.value();
      return this;
    };

    PropertyChain.prototype.value = function(value) {
      var command, cv, hasValue, i, n, pv, _i, _len, _ref;

      hasValue = arguments.length;
      cv = this._self ? this.clip : this.clip.data;
      n = this._commands.length;
      _ref = this._commands;
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        command = _ref[i];
        this.watcher._watch(command.ref, cv);
        if (i === n - 1 && hasValue) {
          if (cv.set) {
            cv.set(command.ref, value);
          } else {
            dref.set(cv, command.ref, value);
          }
        }
        pv = cv;
        cv = cv.get ? cv.get(command.ref) : dref.get(cv, command.ref);
        if (command.args) {
          if (cv && typeof cv === "function") {
            cv = cv != null ? cv.apply(pv, command.args) : void 0;
          } else {
            cv = void 0;
          }
        }
        if (!cv) {
          break;
        }
      }
      this.watcher.currentRef = this;
      return cv;
    };

    return PropertyChain;

  })();

  ScriptWatcher = (function(_super) {
    __extends(ScriptWatcher, _super);

    /*
    */


    function ScriptWatcher(script, clip) {
      this.script = script;
      this.clip = clip;
      this.update = __bind(this.update, this);
      this.modifiers = this.clip.modifiers;
      this.defaultModifiers = defaultModifiers;
      this.options = this.clip.options;
      this._watching = {};
      this.cast = {};
    }

    /*
    */


    ScriptWatcher.prototype.dispose = function() {
      var key;

      for (key in this._watching) {
        this._watching[key].binding.dispose();
      }
      return this._watching = {};
    };

    /*
    */


    ScriptWatcher.prototype.update = function() {
      var newValue;

      newValue = this.script.call(this);
      if (newValue === this.value) {
        return newValue;
      }
      this.emit("change", this.value = newValue);
      return newValue;
    };

    /*
    */


    ScriptWatcher.prototype.watch = function() {
      this.__watch = true;
      this.update();
      return this;
    };

    /*
    */


    ScriptWatcher.prototype.modify = function(modifier, args) {
      var ret;

      this.currentRefs = args.filter(function(arg) {
        return arg.__isPropertyChain;
      });
      ret = modifier.apply(this, args.map(function(arg) {
        if (arg.__isPropertyChain) {
          return arg.value();
        } else {
          return arg;
        }
      }));
      this.currentRefs = [];
      return ret;
    };

    ScriptWatcher.prototype.castAs = function(name) {
      return new PropertyChain(this).castAs(name);
    };

    ScriptWatcher.prototype.ref = function(path) {
      return new PropertyChain(this).ref(path);
    };

    ScriptWatcher.prototype.self = function(path) {
      return new PropertyChain(this).self(path);
    };

    ScriptWatcher.prototype.call = function(path, args) {
      return new PropertyChain(this).call(path, args);
    };

    /*
    */


    ScriptWatcher.prototype._watch = function(path, target) {
      if (!this.__watch) {
        return;
      }
      if (this._watching[path]) {
        if (this._watching[path].target === target) {
          return;
        }
        this._watching[path].binding.dispose();
      }
      return this._watching[path] = {
        target: target,
        binding: target.bind(path).watch(true).to(this.update)
      };
    };

    return ScriptWatcher;

  })(events.EventEmitter);

  ClipWatchers = (function() {
    /*
    */
    function ClipWatchers(clip, scripts) {
      this.clip = clip;
      this._watchers = {};
      this.names = [];
      this._bindScripts(scripts);
    }

    /*
    */


    ClipWatchers.prototype.watch = function() {
      var key, _results;

      _results = [];
      for (key in this._watchers) {
        _results.push(this._watchers[key].watch());
      }
      return _results;
    };

    /*
    */


    ClipWatchers.prototype.dispose = function() {
      var key;

      for (key in this._watchers) {
        this._watchers[key].dispose();
      }
      return this._watchers = {};
    };

    /*
    */


    ClipWatchers.prototype.get = function(name) {
      return this._watchers[name];
    };

    /*
    */


    ClipWatchers.prototype._bindScripts = function(scripts) {
      var scriptName, _results;

      if (typeof scripts === "function") {
        return this._bindScript("value", scripts, true);
      } else {
        _results = [];
        for (scriptName in scripts) {
          _results.push(this._bindScript(scriptName, scripts[scriptName]));
        }
        return _results;
      }
    };

    /*
    */


    ClipWatchers.prototype._bindScript = function(name, script, watch) {
      var watcher,
        _this = this;

      this.names.push(name);
      watcher = new ScriptWatcher(script, this.clip);
      this._watchers[name] = watcher;
      watcher.on("change", function(value) {
        return _this.clip.set(name, value);
      });
      if (watch) {
        return watcher.watch();
      }
    };

    return ClipWatchers;

  })();

  Clip = (function() {
    /*
    */
    function Clip(options) {
      this.options = options;
      this._self = new bindable.Object();
      this.data = new bindable.Object(options.data || {});
      this.modifiers = options.modifiers || {};
      if (this.options.script) {
        this.watchers = new ClipWatchers(this, this.options.script);
      }
      if (options.watch) {
        this.watch();
      }
    }

    Clip.prototype.watch = function() {
      this.watchers.watch();
      return this;
    };

    Clip.prototype.dispose = function() {
      var _ref, _ref1;

      if ((_ref = this._self) != null) {
        _ref.dispose();
      }
      if ((_ref1 = this.watchers) != null) {
        _ref1.dispose();
      }
      this._self = void 0;
      return this._watchers = void 0;
    };

    Clip.prototype.watcher = function(name) {
      return this.watchers.get(name);
    };

    Clip.prototype.get = function() {
      var _ref;

      return (_ref = this._self).get.apply(_ref, arguments);
    };

    Clip.prototype.set = function() {
      var _ref;

      return (_ref = this._self).set.apply(_ref, arguments);
    };

    Clip.prototype.bind = function() {
      var _ref;

      return (_ref = this._self).bind.apply(_ref, arguments);
    };

    return Clip;

  })();

  module.exports = Clip;

  module.exports.Watchers = ClipWatchers;

  module.exports.modifiers = defaultModifiers;

  module.exports.compile = require("./compile");

}).call(this);
