// Generated by CoffeeScript 1.6.2
var EachDecor, async, pilot,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

async = require("async");

pilot = require("pilot-block");

EachDecor = (function(_super) {
  __extends(EachDecor, _super);

  /*
  */


  EachDecor.scriptName = "each";

  /*
  */


  function EachDecor() {
    this._remove = __bind(this._remove, this);
    this._insert = __bind(this._insert, this);    EachDecor.__super__.constructor.apply(this, arguments);
  }

  /*
  */


  EachDecor.prototype.bind = function() {
    var child, _i, _len, _ref, _ref1;

    EachDecor.__super__.bind.call(this);
    _ref = this.children;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      child = _ref[_i];
      child.bind();
    }
    if ((_ref1 = this.script.value) != null ? _ref1.source : void 0) {
      this._ignoreInsert = true;
      this.script.value.bind({
        insert: this._insert,
        remove: this._remove
      });
      return this._ignoreInsert = false;
    }
  };

  /*
  */


  EachDecor.prototype.load = function(context, callback) {
    var item, source, _i, _len, _ref;

    this.context = context;
    this.children = [];
    this.itemName = source = ((_ref = this.script.value) != null ? _ref.source : void 0) ? this.script.value.source() : this.script.value || [];
    for (_i = 0, _len = source.length; _i < _len; _i++) {
      item = source[_i];
      this.children.push(this._createChild(item));
    }
    return async.eachSeries(this.children, (function(child, next) {
      return child.load(context, next);
    }), callback);
  };

  /*
  */


  EachDecor.prototype._createChild = function(item) {
    var data, node;

    data = {};
    data[this.node.clip.get("as") || "item"] = item;
    node = this.node.createContent(data);
    node.item = item;
    return node;
  };

  /*
  */


  EachDecor.prototype._insert = function(item) {
    var node;

    if (this._ignoreInsert) {
      return;
    }
    this.children.push(node = this._createChild(item));
    return node.attach(this.node, this.context);
  };

  /*
  */


  EachDecor.prototype._remove = function(item) {
    var child, i, _i, _len, _ref, _results;

    _ref = this.children;
    _results = [];
    for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
      child = _ref[i];
      if (child.item === item) {
        this.children.splice(i, 1);
        child.section.dispose();
        break;
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  return EachDecor;

})(require("./base"));

module.exports = EachDecor;
